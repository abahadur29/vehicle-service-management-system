<div class="admin-page-container">
  <div class="admin-page-header">
    <h2>Service Request Management</h2>
  </div>

  <mat-card class="admin-card">
    <mat-form-field appearance="outline" class="admin-filter-field">
      <mat-label>Filter requests</mat-label>
      <input matInput (keyup)="applyFilter($event)" placeholder="Ex. Urgent" #input>
      <mat-icon matSuffix>search</mat-icon>
    </mat-form-field>

    <div class="admin-table-container">
    <mat-table [dataSource]="dataSource" matSort>
      <ng-container matColumnDef="id">
        <mat-header-cell *matHeaderCellDef mat-sort-header> Service ID: </mat-header-cell>
        <mat-cell *matCellDef="let service"> #{{ service.id }} </mat-cell>
      </ng-container>

      <ng-container matColumnDef="vehicleModel">
        <mat-header-cell *matHeaderCellDef mat-sort-header> Vehicle </mat-header-cell>
        <mat-cell *matCellDef="let service"> {{ service.vehicleModel }} </mat-cell>
      </ng-container>

      <ng-container matColumnDef="description">
        <mat-header-cell *matHeaderCellDef mat-sort-header> Description </mat-header-cell>
        <mat-cell *matCellDef="let service"> {{ service.description }} </mat-cell>
      </ng-container>

      <ng-container matColumnDef="status">
        <mat-header-cell *matHeaderCellDef mat-sort-header> Status </mat-header-cell>
        <mat-cell *matCellDef="let service">
          <span class="admin-status-badge" 
                [class]="service.status.toLowerCase().replace(' ', '-')"
                [class.cancelled]="service.status === 'Cancelled'">
            {{ service.status }}
          </span>
        </mat-cell>
      </ng-container>

      <ng-container matColumnDef="date">
        <mat-header-cell *matHeaderCellDef mat-sort-header> Date </mat-header-cell>
        <mat-cell *matCellDef="let service"> {{ service.requestedDate | date:'dd/MM/yyyy' }} </mat-cell>
      </ng-container>

      <ng-container matColumnDef="technicianId">
        <mat-header-cell *matHeaderCellDef mat-sort-header> Technician </mat-header-cell>
        <mat-cell *matCellDef="let service">
          @if (service.status === 'Requested') {
            <button mat-raised-button color="primary" (click)="openAssignDialog(service)" class="assign-btn">
              <mat-icon>person_add</mat-icon>
              Assign Technician
            </button>
          } @else {
            <div class="assigned-tech">
              <mat-icon>account_circle</mat-icon>
              <span>{{ service.technicianName || 'Technician Assigned' }}</span>
            </div>
          }
        </mat-cell>
      </ng-container>

      <ng-container matColumnDef="actions">
        <mat-header-cell *matHeaderCellDef> Actions </mat-header-cell>
        <mat-cell *matCellDef="let service">
          <div class="admin-action-buttons">
            <button mat-icon-button color="primary" (click)="viewDetails(service)" matTooltip="View Details">
              <mat-icon>visibility</mat-icon>
            </button>
            <button mat-icon-button color="warn" 
                    *ngIf="service.status !== 'Completed' && service.status !== 'Closed' && service.status !== 'Cancelled'"
                    (click)="cancelRequest(service)"
                    matTooltip="Cancel Request"
                    [disabled]="service.status === 'Cancelled'">
              <mat-icon>cancel</mat-icon>
            </button>
          </div>
        </mat-cell>
      </ng-container>

      <mat-header-row *matHeaderRowDef="displayedColumns"></mat-header-row>
      <mat-row *matRowDef="let row; columns: displayedColumns;"></mat-row>

      <tr class="mat-row no-data-row" *matNoDataRow>
        <td class="mat-cell" colspan="8">
          <div class="admin-no-data">
            <mat-icon>assignment</mat-icon>
            <h3>No Service Requests Found</h3>
            <p *ngIf="input.value">No requests matching the filter "{{input.value}}"</p>
            <p *ngIf="!input.value">No service requests available.</p>
          </div>
        </td>
      </tr>
    </mat-table>

    <mat-paginator class="admin-paginator" [pageSizeOptions]="[5, 10, 25, 100]" aria-label="Select page of requests"></mat-paginator>
  </div>
  </mat-card>
</div>
